<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../cedar-dialog/cedar-dialog.html">
<link rel="import" href="../birch-message/birch-message.html">
<link rel="import" href="../fs-button/fs-button.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">

<!--
A FamilySearch element providing a dialog for viewing a contributor's contact information.

Example:

    <birch-contact-card></birch-contact-card>

Example:

    <birch-contact-card>
      <h2>Hello birch-contact-card</h2>
    </birch-contact-card>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-contact-card">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-contact-card.css">
  <template>
    <wc-i18n-src locale='[[lang]]' locale-dir='[[localeDir()]]' domain='birch-contact-card'></wc-i18n-src>
    <iron-ajax id="getContactInfoReq"
      url="[[ajaxBase]]/ftuser/contacts/[[contactCisId]]"
      headers='[[authHeaders]]'
      method="GET"
      content-type="application/json"
      handle-as="json"
      on-response="_handleContactResponse"
      on-error="_handleContactError"></iron-ajax>
    <birch-message id="message" contact-name="[[contactData.contactName]]" to-user-ids="{{_generateUserIdsArray(contactData.id)}}"></birch-message>
    <cedar-dialog id="dialogBox" position-target="{{_computePositionTarget(mobile, positionTarget)}}" vertical-align="{{verticalAlign}}" mobile="{{mobile}}" horizontal-align="[[horizontalAlign]]" arrow>
      <paper-dialog-scrollable id="scrollable">
        <div class="spinner-icon" hidden="[[!loading]]"></div>
        <h4 id="heading" class="heading" header>[[contactData.contactName]]</h4>
        <div id="innerDialog" class="body" content hidden="[[_error]]">     
        <div class="line-1">
          <div class="left-col">
            <p class="name-heading"><small><wc-i18n key='birch-contact-card.full_name_label'></wc-i18n></small></p>
          </div>
          <div class="right-col">
            <span class="name">[[contactData.fullName]]</span>
          </div>
        </div>
        <div class="line-2">
          <div class="left-col">
            <p class="name-heading"><small><wc-i18n key='birch-contact-card.contact_name_label'></wc-i18n></small></p>
          </div>
          <div class="right-col">
            <span class="name">[[contactData.contactName]]</span>
          </div>
        </div>
        <div class="line-3">
          <div class="left-col">
            <p class="name-heading"><small><wc-i18n key='birch-contact-card.email_address_label'></wc-i18n></small></p>
          </div>
          <div class="right-col">
            <span class="name"><a href$="mailto:{{contactData.email}}">[[contactData.email]]</a></span>
          </div>
        </div>   
        <div class="line-4">
          <div class="left-col">
            <p class="name-heading"><small><wc-i18n key='birch-contact-card.phone_number_label'></wc-i18n></small></p>
          </div>
          <div class="right-col">
            <span class="name">[[contactData.phoneNumber]]</small></span>
          </div>
        </div>
        <div class="line-5">
          <div class="left-col">
            <p class="name-heading"><small><wc-i18n key='birch-contact-card.mailing_address_label'></wc-i18n></small></p>
          </div>
          <div class="right-col">
            <p id="address" class="name">{{contactData.mailingAddress}}</p>
          </div>
        </div>
        <div class="send-button">
          <button is='fs-button' type="button" option="minor" class="message-button" on-tap="_showSendMessage"><wc-i18n key='birch-contact-card.send_message'></wc-i18n></button>
        </div>
        </div>
        <div id="error" hidden="[[!_error]]">
          <div class="fs-alert fs-alert--error">
            <p><wc-i18n id="errorMessageText" key='birch-contact-card.error'></wc-i18n></p>
          </div>
        </div>
      </paper-dialog-scrollable>
    </cedar-dialog>
  </template>

  <script>
    Polymer({
      is: 'birch-contact-card',

      behaviors: [
        OakAJAXBehavior,
        OakI18nBehavior,
        WCI18nBehavior
      ],

      properties: {
        contactCisId: {
          type: String,
          observer: '_setDataRefresh'
        },
        contactData: {
          type: Object,
          value: function() { return {}; }
        },
        dataRefresh: {
          type: Boolean,
          value: true
        },
        generateContactData: {
          type: Boolean,
          value: false
        },
        horizontalAlign: {
          type: String
        },
        loading: {
          type: Boolean,
          value: false
        },
        positionTarget: {
          type: Object
        },
        verticalAlign: {
          type: String
        },
        _error: {
          type: Boolean,
          value: false
        }
      },

      ready: function() {
        this.listen(window, 'resize', '_handleResize');
        this.$.scrollable.dialogElement = Polymer.dom(this.$.dialogBox.root).querySelector('#modal');
      },

      open: function(e) {
        if (this.generateContactData && !this._error && this.dataRefresh) this._triggerContactRequest();
        if (e) this.positionTarget = e.currentTarget;
        this.$.dialogBox.open();
      },

      close: function() {
        this.$.dialogBox.close();
      },

      _computePositionTarget: function (mobile, positionTarget) {
        if (mobile) {
          this.$.dialogBox.arrow = false;
          this.horizontalAlign = undefined;
          this.verticalAlign = undefined;
        } else {
          return positionTarget;
        }
      },

      _handleContactResponse: function(e) {
        this.contactData = e.detail.response;
        this._toggleLoading(false);
      },

      _handleContactError: function(e) {
        this._error = true;
        this._toggleLoading(false);
      },

      _setDataRefresh: function () {
        this.dataRefresh = true;
      },

      _generateUserIdsArray: function(id) {
        if (id) return [id];
      },

      _handleResize: function() {
        this.debounce('resize-debouce-arrow', function() {
          if (this.mobile) {
            this.$.dialogBox.arrow = false;
            this.$.dialogBox.updateArrow();
          }
        }, 300);
      },

      _showSendMessage:function() {
        this.$.message.open();
      },

      _toggleLoading: function(boolean) {
        this.loading = boolean;
        var hideOrShow = (boolean) ? "hidden" : "visible"
        this.$.innerDialog.style.visibility = hideOrShow;  
        this.$.heading.style.visibility = hideOrShow;  
      },

      _triggerContactRequest: function() {
        this._toggleLoading(true);
        this.$.getContactInfoReq.generateRequest();
        this.dataRefresh = false;
      }

    });
  </script>
</dom-module>
